#!/bin/bash

# Pre-commit hook to validate code quality
# This hook runs checkstyle to ensure code quality standards are met
# Note: Automatic formatting has been disabled to prevent conflicts with checkstyle rules

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Running pre-commit code quality checks...${NC}"

# Get list of staged Java files
STAGED_JAVA_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.java$' || true)

if [ -z "$STAGED_JAVA_FILES" ]; then
    echo -e "${GREEN}✓ No Java files to check${NC}"
    exit 0
fi

echo -e "${YELLOW}Found $(echo "$STAGED_JAVA_FILES" | wc -l | tr -d ' ') staged Java file(s)${NC}"

# Check if Maven is available
if ! command -v mvn &> /dev/null; then
    echo -e "${RED}✗ Error: Maven is not installed or not in PATH${NC}"
    exit 1
fi

# Change to project root
cd "$(git rev-parse --show-toplevel)"

# Run checkstyle check
echo -e "${YELLOW}Running checkstyle validation...${NC}"
if mvn checkstyle:check -q 2>&1 | grep -q "violations"; then
    echo -e "${RED}✗ Checkstyle violations found${NC}"
    echo -e "${YELLOW}Please fix the violations before committing.${NC}"
    echo -e "${YELLOW}Run 'mvn checkstyle:check' to see details.${NC}"
    exit 1
fi

# Check if checkstyle actually found violations (exit code check)
mvn checkstyle:check > /tmp/checkstyle-output.txt 2>&1
CHECKSTYLE_EXIT=$?

if [ $CHECKSTYLE_EXIT -ne 0 ]; then
    # Check if there are actual violations (not just warnings)
    if grep -q "violations" /tmp/checkstyle-output.txt; then
        echo -e "${RED}✗ Checkstyle violations found${NC}"
        cat /tmp/checkstyle-output.txt | grep -E "(WARN|ERROR)" | head -20
        echo ""
        echo -e "${YELLOW}Please fix the violations before committing.${NC}"
        echo -e "${YELLOW}Run 'mvn checkstyle:check' to see full details.${NC}"
        rm -f /tmp/checkstyle-output.txt
        exit 1
    fi
fi

rm -f /tmp/checkstyle-output.txt
echo -e "${GREEN}✓ Code quality checks passed${NC}"
exit 0

