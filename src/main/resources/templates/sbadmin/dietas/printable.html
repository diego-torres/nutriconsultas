<!DOCTYPE html>
<!--
	TEMPLATE: sbadmin/dietas/printable.html
	
	PURPOSE:
	This template generates a printable PDF version of a dietary plan (Dieta).
	It supports TWO usage scenarios:
	
	1. UNASSIGNED DIETA (Generic Template):
	   - Used when a dieta has not been assigned to any patient
	   - Patient information section is hidden (paciente == null)
	   - Shows only: dieta name, ingestas, platillos, alimentos, and nutritional information
	   - Suitable for generic diet plans or templates
	
	2. ASSIGNED DIETA (Patient-Specific Template):
	   - Used when a dieta has been assigned to a specific patient
	   - Patient information section is displayed (paciente != null)
	   - Shows: patient details, assignment dates, notes (if any), plus all dieta content
	   - Suitable for patient-specific dietary plans
	
	CONDITIONAL RENDERING:
	- Patient info section: Only shown if ${paciente != null}
	- Assignment dates: Only shown if ${pacienteDieta != null} and dates exist
	- Notes: Only shown if ${pacienteDieta != null} and notes exist
	
	REQUIRED MODEL VARIABLES:
	- dieta: Dieta entity (required)
	- ingestas: List<Ingesta> sorted by id (required)
	- ingestaTotals: Map<Long, IngestaNutritionalTotals> (required)
	- totalEnergia, totalProteina, totalLipidos, totalHidratosDeCarbono: Total nutritional values (required)
	- paciente: Paciente entity (optional, null for unassigned dietas)
	- pacienteDieta: PacienteDieta entity (optional, null for unassigned dietas)
	
	USAGE:
	This template is processed by DietaPdfService.generatePdf() which automatically
	determines if the dieta is assigned and sets the appropriate variables.
-->
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
	<meta charset="UTF-8" />
	<title>Plan de Alimentación - <span th:text="${dieta != null ? dieta.nombre : 'Dieta'}"></span></title>
	<style>
		@page {
			size: A4;
			margin: 2cm;
		}
		body {
			font-family: Arial, sans-serif;
			font-size: 11pt;
			line-height: 1.4;
			color: #333;
		}
		.header {
			border-bottom: 3px solid #4e73df;
			padding-bottom: 15px;
			margin-bottom: 20px;
		}
		.header h1 {
			color: #4e73df;
			margin: 0;
			font-size: 24pt;
		}
		.header p {
			margin: 5px 0;
			color: #666;
		}
		.patient-info {
			background-color: #f8f9fc;
			padding: 15px;
			border-radius: 5px;
			margin-bottom: 20px;
		}
		.patient-info h2 {
			margin-top: 0;
			color: #4e73df;
			font-size: 16pt;
		}
		.patient-info table {
			width: 100%;
			border-collapse: collapse;
		}
		.patient-info td {
			padding: 5px 10px;
			border-bottom: 1px solid #e3e6f0;
		}
		.patient-info td:first-child {
			font-weight: bold;
			width: 40%;
		}
		.dieta-info {
			margin-bottom: 20px;
		}
		.dieta-info h2 {
			color: #4e73df;
			font-size: 18pt;
			margin-bottom: 10px;
		}
		.ingesta-section {
			margin-bottom: 30px;
			page-break-inside: avoid;
		}
		.ingesta-header {
			background-color: #4e73df;
			color: white;
			padding: 10px 15px;
			font-size: 14pt;
			font-weight: bold;
			border-radius: 5px 5px 0 0;
		}
		.ingesta-content {
			border: 1px solid #e3e6f0;
			border-top: none;
			padding: 15px;
		}
		.platillo-item, .alimento-item {
			margin-bottom: 15px;
			padding-bottom: 15px;
			border-bottom: 1px solid #e3e6f0;
		}
		.platillo-item:last-child, .alimento-item:last-child {
			border-bottom: none;
		}
		.item-name {
			font-weight: bold;
			font-size: 12pt;
			color: #2c3e50;
			margin-bottom: 5px;
		}
		.item-details {
			font-size: 10pt;
			color: #666;
			margin-left: 15px;
		}
		.item-details table {
			width: 100%;
			border-collapse: collapse;
			margin-top: 5px;
		}
		.item-details th, .item-details td {
			padding: 5px;
			text-align: left;
			border-bottom: 1px solid #e3e6f0;
		}
		.item-details th {
			background-color: #f8f9fc;
			font-weight: bold;
		}
		.ingrediente-item {
			margin-left: 20px;
			font-size: 10pt;
			color: #555;
		}
		.nutrition-summary {
			background-color: #f8f9fc;
			padding: 10px;
			border-radius: 5px;
			margin-top: 10px;
		}
		.nutrition-summary table {
			width: 100%;
			border-collapse: collapse;
		}
		.nutrition-summary th, .nutrition-summary td {
			padding: 8px;
			text-align: left;
			border-bottom: 1px solid #e3e6f0;
		}
		.nutrition-summary th {
			background-color: #4e73df;
			color: white;
			font-weight: bold;
		}
		.nutrition-summary .total-row {
			font-weight: bold;
			background-color: #e3e6f0;
		}
		.footer {
			margin-top: 30px;
			padding-top: 15px;
			border-top: 2px solid #e3e6f0;
			text-align: center;
			color: #666;
			font-size: 9pt;
		}
		.recommendations {
			font-style: italic;
			color: #666;
			margin-top: 5px;
		}
	</style>
</head>
<body>
	<div class="header">
		<h1>Plan de Alimentación</h1>
		<p>Minutriporcion - Consulta Nutricional</p>
	</div>

	<div th:if="${paciente != null}" class="patient-info">
		<h2>Información del Paciente</h2>
		<table>
			<tr>
				<td>Nombre:</td>
				<td th:text="${paciente.name}"></td>
			</tr>
			<tr th:if="${paciente.dob != null}">
				<td>Fecha de Nacimiento:</td>
				<td th:text="${#dates.format(paciente.dob, 'dd/MM/yyyy')}"></td>
			</tr>
			<tr th:if="${paciente.gender != null}">
				<td>Género:</td>
				<td th:text="${paciente.gender == 'M' ? 'Masculino' : (paciente.gender == 'F' ? 'Femenino' : paciente.gender)}"></td>
			</tr>
			<tr th:if="${paciente.peso != null}">
				<td>Peso:</td>
				<td th:text="${paciente.peso + ' kg'}"></td>
			</tr>
			<tr th:if="${paciente.estatura != null}">
				<td>Estatura:</td>
				<td th:text="${paciente.estatura + ' m'}"></td>
			</tr>
			<tr th:if="${pacienteDieta != null && pacienteDieta.startDate != null}">
				<td>Fecha de Inicio:</td>
				<td th:text="${#dates.format(pacienteDieta.startDate, 'dd/MM/yyyy')}"></td>
			</tr>
			<tr th:if="${pacienteDieta != null && pacienteDieta.endDate != null}">
				<td>Fecha de Fin:</td>
				<td th:text="${#dates.format(pacienteDieta.endDate, 'dd/MM/yyyy')}"></td>
			</tr>
			<tr th:if="${pacienteDieta != null && pacienteDieta.notes != null && !pacienteDieta.notes.isEmpty()}">
				<td>Notas:</td>
				<td th:text="${pacienteDieta.notes}"></td>
			</tr>
		</table>
	</div>

	<div class="dieta-info">
		<h2 th:text="${dieta != null ? dieta.nombre : 'Dieta'}">Dieta</h2>
	</div>

	<div th:each="ingesta : ${ingestas}" class="ingesta-section">
		<div class="ingesta-header" th:text="${ingesta.nombre}">Ingesta</div>
		<div class="ingesta-content">
			<!-- Platillos -->
			<div th:each="platillo : ${ingesta.platillos}" class="platillo-item">
				<div class="item-name" th:text="${platillo.name + (platillo.portions != null && platillo.portions > 1 ? ' (' + platillo.portions + ' porciones)' : '')}">Platillo</div>
				<div class="item-details">
					<div th:if="${platillo.recommendations != null && !platillo.recommendations.isEmpty()}" class="recommendations" th:text="${'Recomendaciones: ' + platillo.recommendations}"></div>
					<div th:if="${platillo.ingredientes != null && !platillo.ingredientes.isEmpty()}">
						<p style="margin-top: 5px; margin-bottom: 5px;"><strong>Ingredientes:</strong></p>
						<div th:each="ingrediente : ${platillo.ingredientes}" class="ingrediente-item" th:with="showInGrams=${ingrediente.cantSugerida != null && ingrediente.unidad != null && ingrediente.unidad.equals('taza') && ingrediente.cantSugerida < 0.25 && ingrediente.pesoBrutoRedondeado != null}">
							<span th:text="${(ingrediente.alimento != null && ingrediente.alimento.nombreAlimento != null) ? ingrediente.alimento.nombreAlimento : (ingrediente.description != null ? ingrediente.description : '')}"></span>
							<!-- Show in grams if less than 0.25 taza, otherwise show rounded fractional quantity (rounded to nearest 0.25) -->
							<span th:if="${showInGrams}" th:text="${' - ' + ingrediente.pesoBrutoRedondeado + ' g'}"></span>
							<span th:if="${ingrediente.cantSugerida != null && !showInGrams}" th:text="${' - ' + ingrediente.getRoundedFractionalCantSugerida()}"></span>
							<span th:if="${ingrediente.unidad != null && !showInGrams}" th:text="${' ' + ingrediente.unidad}"></span>
						</div>
					</div>
					<div th:if="${platillo.pesoBrutoRedondeado != null || platillo.pesoNeto != null}" class="nutrition-summary">
						<table>
							<tr>
								<th>Información Nutricional</th>
								<th>Valor</th>
							</tr>
							<tr th:if="${platillo.pesoBrutoRedondeado != null}">
								<td>Peso Bruto:</td>
								<td th:text="${platillo.pesoBrutoRedondeado + ' g'}"></td>
							</tr>
							<tr th:if="${platillo.pesoNeto != null}">
								<td>Peso Neto:</td>
								<td th:text="${platillo.pesoNeto + ' g'}"></td>
							</tr>
							<tr th:if="${platillo.energia != null}">
								<td>Energía:</td>
								<td th:text="${platillo.energia + ' kcal'}"></td>
							</tr>
							<tr th:if="${platillo.proteina != null}">
								<td>Proteína:</td>
								<td th:text="${#numbers.formatDecimal(platillo.proteina, 1, 2) + ' g'}"></td>
							</tr>
							<tr th:if="${platillo.lipidos != null}">
								<td>Lípidos:</td>
								<td th:text="${#numbers.formatDecimal(platillo.lipidos, 1, 2) + ' g'}"></td>
							</tr>
							<tr th:if="${platillo.hidratosDeCarbono != null}">
								<td>Hidratos de Carbono:</td>
								<td th:text="${#numbers.formatDecimal(platillo.hidratosDeCarbono, 1, 2) + ' g'}"></td>
							</tr>
						</table>
					</div>
				</div>
			</div>

			<!-- Alimentos -->
			<div th:each="alimento : ${ingesta.alimentos}" class="alimento-item">
				<div class="item-name" th:text="${alimento.name + (alimento.portions != null && alimento.portions > 1 ? ' (' + alimento.portions + ' porción' + (alimento.portions > 1 ? 'es' : '') + ')' : '')}">Alimento</div>
				<div class="item-details" th:if="${alimento.alimento != null && (alimento.alimento.cantSugerida != null || alimento.unidad != null)}">
					<div style="margin-top: 5px; font-size: 10pt; color: #666;">
						<span th:if="${alimento.alimento.cantSugerida != null}" th:text="${alimento.alimento.getRoundedFractionalCantSugerida()}"></span>
						<span th:if="${alimento.alimento.cantSugerida != null && alimento.unidad != null}" th:text="${' '}"></span>
						<span th:if="${alimento.unidad != null}" th:text="${alimento.unidad}"></span>
					</div>
				</div>
			</div>

			<!-- Resumen nutricional de la ingesta -->
			<div class="nutrition-summary" style="margin-top: 15px;" th:if="${ingestaTotals != null && ingestaTotals.containsKey(ingesta.id)}" th:with="totals=${ingestaTotals.get(ingesta.id)}">
				<table>
					<tr>
						<th colspan="2">Resumen Nutricional - <span th:text="${ingesta.nombre}"></span></th>
					</tr>
					<tr>
						<td>Energía Total:</td>
						<td th:text="${totals != null && totals.totalEnergia != null ? (totals.totalEnergia + ' kcal') : '0 kcal'}"></td>
					</tr>
					<tr>
						<td>Proteína Total:</td>
						<td th:text="${totals != null && totals.totalProteina != null ? (#numbers.formatDecimal(totals.totalProteina, 1, 2) + ' g') : '0.0 g'}"></td>
					</tr>
					<tr>
						<td>Lípidos Total:</td>
						<td th:text="${totals != null && totals.totalLipidos != null ? (#numbers.formatDecimal(totals.totalLipidos, 1, 2) + ' g') : '0.0 g'}"></td>
					</tr>
					<tr>
						<td>Hidratos de Carbono Total:</td>
						<td th:text="${totals != null && totals.totalHidratosDeCarbono != null ? (#numbers.formatDecimal(totals.totalHidratosDeCarbono, 1, 2) + ' g') : '0.0 g'}"></td>
					</tr>
				</table>
			</div>
		</div>
	</div>

	<!-- Resumen nutricional total de la dieta -->
	<div class="nutrition-summary" style="margin-top: 30px;">
		<table>
			<tr>
				<th colspan="2">Resumen Nutricional Total</th>
			</tr>
			<tr class="total-row">
				<td>Energía Total:</td>
				<td th:text="${totalEnergia != null ? (totalEnergia + ' kcal') : '0 kcal'}"></td>
			</tr>
			<tr class="total-row">
				<td>Proteína Total:</td>
				<td th:text="${totalProteina != null ? (#numbers.formatDecimal(totalProteina, 1, 2) + ' g') : '0.0 g'}"></td>
			</tr>
			<tr class="total-row">
				<td>Lípidos Total:</td>
				<td th:text="${totalLipidos != null ? (#numbers.formatDecimal(totalLipidos, 1, 2) + ' g') : '0.0 g'}"></td>
			</tr>
			<tr class="total-row">
				<td>Hidratos de Carbono Total:</td>
				<td th:text="${totalHidratosDeCarbono != null ? (#numbers.formatDecimal(totalHidratosDeCarbono, 1, 2) + ' g') : '0.0 g'}"></td>
			</tr>
		</table>
	</div>

	<div class="footer">
		<p>Este documento fue generado el <span th:text="${#temporals.format(#temporals.createNow(), 'dd/MM/yyyy HH:mm')}"></span></p>
		<p>Minutriporcion - Consulta Nutricional Profesional</p>
	</div>
</body>
</html>

